---
title: "WSGI, Graceful shutdown"
categories: [blog]
---

## 1. WSGI가 FastCGI보다 중요한 전환점인 이유

### FastCGI가 해결한 문제

* CGI의 가장 큰 문제(요청마다 프로세스 생성)를 해결.
* 프로세스를 유지하면서 소켓으로 통신 → 성능 대폭 개선.
* 하지만 **언어/프레임워크 표준화는 전혀 못함.**

### WSGI가 바꾼 점

* Python 웹 생태계를 완전히 **표준화**함.
* 서버(Daphne, Gunicorn, uWSGI)와 프레임워크(Django, Flask, Bottle 등)가 모두 같은 인터페이스(WSGI)를 사용.
* 프레임워크 간 호환성 확보.
* 미들웨어 생태계 형성.
* Python 웹이 통합된 구조로 진화할 기반을 제공.
* ASGI로 자연스러운 확장 가능.

### 결론

**FastCGI = 성능 개선**
**WSGI = 생태계 혁신(표준화)**

---

## 2. CGI Script란 무엇인가?

### CGI(Common Gateway Interface)

* 1990년대 초기부터 존재한 웹의 원시적인 실행 방식.
* 웹 요청 1개 → 외부 프로그램 1개 실행.
* 출력(stdout)이 그대로 HTTP Response로 반환됨.
* 언어 제한 없음(Python, Perl, bash 등).

### 단점

* 요청마다 프로세스 실행 → 매우 느림.
* 상태 유지 불가(DB connection, 메모리 캐시 불가).
* 보안 취약.
* 현대 웹 기능(WebSocket, keepalive 등) 지원 불가.

---

## 3. socket.SO_REUSEADDR의 기능

### 역할

* TIME_WAIT 중인 포트도 **즉시 bind 가능**하게 해주는 옵션.
* 개발/운영에서 서버 재시작 시 “Address already in use” 방지.

### 정확한 의미

* OS에서 소켓 주소(address) = (IP + Port)
* 따라서 포트를 다시 여는 것은 OS 관점에서는 “주소 재사용”

### 위험성

* 지연 패킷이 새 서버로 들어올 수 있는 이론적인 위험 존재.
* 그러나 현대 서버들은 대부분 잘 처리하여 문제 거의 없음.

---

## 4. 운영환경에서 SO_REUSEADDR는 켜고, SO_REUSEPORT는 조심하는 이유

### SO_REUSEADDR

* TIME_WAIT 포트 재사용 허용.
* 안전함.
* 운영환경에서 일반적으로 켜둠.
* 주로 "빠른 재시작" 목적.

### SO_REUSEPORT

* 여러 프로세스가 같은 포트에 동시에 `bind()` 가능.
* 커널이 들어오는 연결을 round-robin으로 분배.
* 의도치 않은 다중 서버 실행 + 세션 깨짐 + 보안 위험.
* 실전 운영에서는 매우 위험함.

---

## 5. TIME_WAIT이 먼저 종료하는 쪽에서 발생하는 이유

### 이유 1. 지연 패킷(dangling packets) 처리 책임

먼저 FIN을 보낸 쪽이 TIME_WAIT에 머무르며:

* 늦게 도착한 패킷 처리
* 중복 FIN/ACK 처리
* 새 연결이 오염되지 않도록 차단

### 이유 2. 프로토콜 종료 안정성

TCP 철학:

> “연결을 끊겠다고 한 쪽이 종료 과정의 책임을 진다.”

---

## 6. Graceful Shutdown이 TIME_WAIT을 거의 남기지 않는 이유

### 핵심 원리

**서버가 먼저 FIN을 보내지 않기 때문**

수행 순서:

1. 새 연결 수락 중지(accept stop)
2. 기존 요청 처리 완료까지 기다림
3. 클라이언트가 먼저 FIN 보내도록 유도
4. 서버는 FIN에 응답만 함 → TIME_WAIT은 클라이언트가 가짐

### 결과

* 서버 측 TIME_WAIT 거의 없음
* 지연 패킷 문제 없음
* 롤링 업데이트 안정성 확보

---

## 7. REUSEADDR이 있어도 Graceful Shutdown이 필요한 이유

### REUSEADDR은 단지 **포트만 다시 열 수 있게** 해주는 것

다음 문제는 해결 못함:

* 미완료 요청 강제 종료
* DB 트랜잭션 중단
* WebSocket/stream 끊김
* 세션 기반 서비스 오류
* 지연 패킷이 새 서버로 들어올 위험
* 롤링 업데이트 불가

### Graceful Shutdown의 목적

* 요청 정상 처리
* 연결 자연 종료
* TIME_WAIT을 클라이언트로 전가
* 운영 환경 안정성 극대화

---

## 8. 왜 이름이 REUSEADDR인가?

### 이유

TCP 소켓의 주소(address)는 **(IP + Port)** 조합을 의미하기 때문.

* UNIX 소켓 API 초기 설계(BSD)에서 “주소 = 포트 포함”
* 포트는 주소의 일부 → 포트 재사용 = 주소 재사용 → SO_REUSEADDR